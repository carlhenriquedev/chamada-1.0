<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendário</title>
    <link rel="stylesheet" href="css/calendario.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            min-height: 100vh;
            min-width: 100vw;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        .calendario-topo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            width: 100%;
            max-width: 100vw;
            font-size: 1.3em;
            font-weight: bold;
            padding: 20px 0 10px 0;
        }
        .calendario-seta {
            cursor: pointer;
            padding: 0 15px;
            color: #007bff;
            text-decoration: none;
            font-size: 1.5em;
            user-select: none;
        }
        .calendario-seta:hover {
            color: #0056b3;
        }
        table.calendario {
            border-collapse: collapse;
            width: 100vw;
            height: 100%;
            table-layout: fixed;
            background: #fff;
        }
        table.calendario th, table.calendario td {
            border: 1px solid #ccc;
            width: 14.28%;
            height: calc((100vh - 70px) / 7);
            text-align: left;
            vertical-align: top;
            font-size: 1em;
            padding: 4px;
            box-sizing: border-box;
            position: relative;
        }
        table.calendario th {
            background: #f0f0f0;
            text-align: center;
            height: 40px;
        }
        .evento-pill {
            display: inline-block;
            background: #007bff;
            color: #fff;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.95em;
            margin: 2px 2px 2px 0;
            white-space: nowrap;
        }
        .falta {
            background: orange !important;
        }
        @media (max-width: 700px) {
            table.calendario th, table.calendario td {
                font-size: 0.8em;
                padding: 2px;
            }
            .evento-pill {
                font-size: 0.8em;
                padding: 1px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="calendario-topo">
        <span class="calendario-seta" id="seta-esquerda">&lt;</span>
        <span id="calendario-mes-ano" style="flex:1; text-align:center;"></span>
        <span class="calendario-seta" id="seta-direita">&gt;</span>
    </div>
    <table class="calendario" id="calendario-tabela">
        <thead>
            <tr id="calendario-dias-semana"></tr>
        </thead>
        <tbody id="calendario-corpo">
        </tbody>
    </table>
    <script>
        const nomesMeses = [
            '', 'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];
        const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];

        let mesAtual = (new URLSearchParams(window.location.search).get('mes')) ? parseInt(new URLSearchParams(window.location.search).get('mes')) : (new Date().getMonth() + 1);
        let anoAtual = (new URLSearchParams(window.location.search).get('ano')) ? parseInt(new URLSearchParams(window.location.search).get('ano')) : (new Date().getFullYear());

        let eventos = [];

        function renderizarTopo() {
            document.getElementById('calendario-mes-ano').textContent = `${nomesMeses[mesAtual]} - ${anoAtual}`;
        }

        function renderizarDiasSemana() {
            const linha = document.getElementById('calendario-dias-semana');
            linha.innerHTML = '';
            diasSemana.forEach(dia => {
                const th = document.createElement('th');
                th.textContent = dia;
                linha.appendChild(th);
            });
        }

        function renderizarDias() {
            const corpo = document.getElementById('calendario-corpo');
            corpo.innerHTML = '';
            const primeiroDia = new Date(anoAtual, mesAtual - 1, 1).getDay(); // 0 (Dom) a 6 (Sáb)
            const totalDias = new Date(anoAtual, mesAtual, 0).getDate();
            let dia = 1;
            for (let linha = 0; linha < 6; linha++) {
                const tr = document.createElement('tr');
                for (let col = 0; col < 7; col++) {
                    const td = document.createElement('td');
                    if (linha === 0 && col < primeiroDia) {
                        td.textContent = '';
                    } else if (dia > totalDias) {
                        td.textContent = '';
                    } else {
                        // Data no formato YYYY-MM-DD
                        const dataStr = `${anoAtual}-${String(mesAtual).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                        // Filtra eventos do dia
                        const eventosDoDia = eventos.filter(ev => ev.data === dataStr);
                        let faltou = false;
                        eventosDoDia.forEach(ev => {
                            const pill = document.createElement('span');
                            pill.className = 'evento-pill';
                            pill.textContent = ev.titulo;
                            td.appendChild(pill);
                            if (ev.faltou === true || ev.faltou === 1 || ev.faltou === "1") {
                                faltou = true;
                            }
                        });
                        if (faltou) {
                            td.classList.add('falta');
                        }
                        // Número do dia no canto superior esquerdo
                        const numDia = document.createElement('div');
                        numDia.style.position = 'absolute';
                        numDia.style.top = '2px';
                        numDia.style.left = '4px';
                        numDia.style.fontWeight = 'bold';
                        numDia.style.fontSize = '1em';
                        numDia.textContent = dia;
                        td.appendChild(numDia);
                        td.style.position = 'relative';
                        dia++;
                    }
                    tr.appendChild(td);
                }
                corpo.appendChild(tr);
                if (dia > totalDias) break;
            }
        }

        function navegar(mudanca) {
            mesAtual += mudanca;
            if (mesAtual < 1) {
                mesAtual = 12;
                anoAtual--;
            } else if (mesAtual > 12) {
                mesAtual = 1;
                anoAtual++;
            }
            atualizarCalendario();
            // Atualiza a URL sem recarregar a página
            const params = new URLSearchParams(window.location.search);
            params.set('mes', mesAtual);
            params.set('ano', anoAtual);
            window.history.replaceState({}, '', `${location.pathname}?${params}`);
        }

        function atualizarCalendario() {
            renderizarTopo();
            renderizarDiasSemana();
            renderizarDias();
        }

        async function carregarEventos() {
            try {
                const resp = await fetch('http://localhost/chamada-1.0/calendario_database_mock.json');
                if (!resp.ok) throw new Error('Erro ao carregar eventos');
                eventos = await resp.json();
            } catch (e) {
                eventos = [];
            }
            atualizarCalendario();
        }

        document.getElementById('seta-esquerda').addEventListener('click', () => navegar(-1));
        document.getElementById('seta-direita').addEventListener('click', () => navegar(1));

        carregarEventos();
    </script>
</body>
</html>